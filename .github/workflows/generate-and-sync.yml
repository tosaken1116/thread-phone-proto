name: Generate and Sync to thread-phone

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:

jobs:
  generate-and-sync:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Setup tools and generate
        run: |
          task setup-tools
          task generate
          # Verify generation worked
          echo "=== Generated files structure ==="
          find . -name "*.ts" -path "*/gen/*" | head -10 || echo "No TypeScript files in gen/"
          ls -la gen/ 2>/dev/null || echo "gen/ directory not found"
          # Check actual directory structure  
          echo "=== Full directory tree ==="
          find . -type d -name "*gen*" -exec ls -la {} \; || echo "No gen directories"
          find . -name "*.ts" -path "*string_phone*" | head -5

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: tosaken1116/thread-phone
          token: ${{ secrets.PAT_TOKEN }}
          path: thread-phone

      - name: Copy generated files
        run: |
          # Remove existing generated files
          rm -rf thread-phone/src/generated
          mkdir -p thread-phone/src/generated
          
          # Find and copy TypeScript files
          echo "=== Searching for generated TypeScript files ==="
          if [ -d "gen/ts/string_phone" ]; then
            echo "Found gen/ts/string_phone directory"
            cp -r gen/ts/string_phone/* thread-phone/src/generated/
            echo "Copied files successfully"
          elif [ -d "gen/ts" ]; then
            echo "Found gen/ts directory but no string_phone subdirectory"
            ls -la gen/ts/
            # Copy the entire gen/ts structure
            cp -r gen/ts/* thread-phone/src/generated/ 2>/dev/null || echo "Failed to copy TS files"
          else
            echo "=== Debugging: Looking for any generated files ==="
            find . -name "*.ts" -type f | grep -v node_modules | grep -v thread-phone | head -10
            echo "=== Directory structure ==="
            ls -la
            echo "=== Contents of potential gen directories ==="
            find . -type d -name "*gen*" -exec ls -la {} \; || echo "No gen directories found"
            exit 1
          fi
          
          # Verify copy worked
          echo "=== Verifying copied files ==="
          ls -la thread-phone/src/generated/ || echo "Generated directory is empty"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          path: thread-phone
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "feat: update generated protobuf files from string-phone-proto"
          title: "Update generated protobuf files"
          body: |
            ## 概要
            string-phone-protoリポジトリで生成されたProtocol Buffersファイルを自動同期しました。

            ## 変更内容
            - `src/generated/` 配下のTypeScriptファイルを更新

            ## 関連コミット
            - Source commit: ${{ github.sha }}
            - Repository: ${{ github.repository }}

            🤖 この PR は自動生成されました
          branch: update-protobuf-${{ github.run_number }}
          delete-branch: true
